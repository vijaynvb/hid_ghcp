name: CI Build and Publish

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_TAG: ${{ github.sha }}

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-publish:
    runs-on: Vijays-MacBook-Pro
    permissions:
      contents: read
      packages: write
      actions: read
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      # - name: Set up JDK 11
      #   uses: actions/setup-java@v4
      #   with:
      #     distribution: temurin
      #     java-version: "11"
      #     cache: maven

      # - name: Backend unit tests
      #   run: mvn -B -ntp -f backend/pom.xml clean verify

      # - name: Set up Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: "18"
      #     cache: npm
      #     cache-dependency-path: frontend/package-lock.json

      # - name: Install frontend dependencies
      #   working-directory: frontend
      #   run: npm ci

      # - name: Frontend unit tests
      #   working-directory: frontend
      #   env:
      #     CI: "true"
      #   run: npm test -- --watch=false --browsers=ChromeHeadless

      # - name: Frontend production build
      #   working-directory: frontend
      #   env:
      #     CI: "true"
      #   run: npm run build

      # - name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v3

      
      - name: Build backend image
        env:
          DOCKER_REGISTRY: ${{ secrets.ARTIFACTORY_DOCKER_REGISTRY }}
        run: |
          docker build -t backend-ci:${{ env.IMAGE_TAG }} backend
          docker tag backend-ci:${{ env.IMAGE_TAG }} "$DOCKER_REGISTRY/task-backend:${{ env.IMAGE_TAG }}"
          docker tag backend-ci:${{ env.IMAGE_TAG }} "$DOCKER_REGISTRY/task-backend:latest"

      - name: Build frontend image
        env:
          DOCKER_REGISTRY: ${{ secrets.ARTIFACTORY_DOCKER_REGISTRY }}
        run: |
          docker build -t frontend-ci:${{ env.IMAGE_TAG }} frontend
          docker tag frontend-ci:${{ env.IMAGE_TAG }} "$DOCKER_REGISTRY/task-frontend:${{ env.IMAGE_TAG }}"
          docker tag frontend-ci:${{ env.IMAGE_TAG }} "$DOCKER_REGISTRY/task-frontend:latest"

      - name: Log in to Artifactory registry
        env:
          DOCKER_USERNAME: ${{ secrets.ARTIFACTORY_DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.ARTIFACTORY_DOCKER_PASSWORD }}
          DOCKER_REGISTRY: ${{ secrets.ARTIFACTORY_DOCKER_REGISTRY }}
        run: |
          echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USERNAME" --password-stdin

      - name: Publish backend image
        env:
          DOCKER_REGISTRY: ${{ secrets.ARTIFACTORY_DOCKER_REGISTRY }}
        run: |
          docker push "$DOCKER_REGISTRY/task-backend:${{ env.IMAGE_TAG }}"
          docker push "$DOCKER_REGISTRY/task-backend:latest"

      - name: Publish frontend image
        env:
          DOCKER_REGISTRY: ${{ secrets.ARTIFACTORY_DOCKER_REGISTRY }}
        run: |
          docker push "$DOCKER_REGISTRY/task-frontend:${{ env.IMAGE_TAG }}"
          docker push "$DOCKER_REGISTRY/task-frontend:latest"

      - name: Publish backend package to Artifactory
        if: ${{ secrets.ARTIFACTORY_GENERIC_REPOSITORY != '' }}
        env:
          ARTIFACTORY_URL: ${{ secrets.ARTIFACTORY_URL }}
          ARTIFACTORY_GENERIC_REPOSITORY: ${{ secrets.ARTIFACTORY_GENERIC_REPOSITORY }}
          ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_DOCKER_USERNAME }}
          ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_DOCKER_PASSWORD }}
        run: |
          set -euo pipefail
          JAR_PATH="$(ls backend/target/*.jar | head -n 1)"
          ARTIFACT_NAME="$(basename "$JAR_PATH")"
          curl -u "$ARTIFACTORY_USERNAME:$ARTIFACTORY_PASSWORD" \
            -T "$JAR_PATH" \
            "$ARTIFACTORY_URL/$ARTIFACTORY_GENERIC_REPOSITORY/backend/${{ env.IMAGE_TAG }}/$ARTIFACT_NAME"
